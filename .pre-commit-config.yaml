# Pre-commit hooks configuration for AI-Tutor project
# This configuration ensures code quality and consistency across the team
#
# Installation:
#   pip install pre-commit
#   pre-commit install
#
# Usage:
#   pre-commit run --all-files  # Run on all files
#   git commit                 # Hooks run automatically on commit

repos:
  # ============================================
  # General file checks
  # ============================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: ^(assets/roster/.*\.svg|.*\.min\.(js|css)|.*\.lock|.*\.log|.*\.pdf|.*\.zip|.*\.tar\.gz)

      - id: end-of-file-fixer
        exclude: ^(assets/roster/.*\.svg|.*\.min\.(js|css)|.*\.lock|.*\.log|.*\.pdf|.*\.zip|.*\.tar\.gz)

      - id: check-yaml
        args: [--unsafe]

      - id: check-json
        exclude: ^(.*\.lock|.*\.log)

      - id: check-added-large-files
        args: [--maxkb=6144]

      - id: check-merge-conflict
      - id: check-case-conflict
      - id: check-toml

  # ============================================
  # Python code formatting and linting
  # ============================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.7
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format

  # ============================================
  # Frontend code formatting and linting
  # ============================================
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        files: ^web/.*\.(css|scss|json|jsonc|yaml|yml|md|graphql|html|ts|tsx|js|jsx)$
        exclude: ^web/(node_modules|\.next|out|dist|build)/

  # ============================================
  # Security checks
  # ============================================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        args: ['--baseline', '.secrets.baseline']
        exclude: package-lock.json
        pass_filenames: false

  # ============================================
  # Runtime dependency policy enforcement
  # ============================================
  #
  # CRITICAL POLICY:
  # ----------------
  # Pillow and reportlab MUST NOT appear in requirements.txt.
  #
  # These libraries:
  #   - introduce native allocators (fonts, images, caches)
  #   - make RSS behavior non-deterministic
  #   - obscure ingestion-related memory signals
  #
  # They are CI-only tools (synthetic PDF generation) and belong
  # exclusively in requirements-dev.txt.
  #
  # This hook enforces that boundary locally, before CI.
  #
  - repo: local
    hooks:
      - id: forbid-runtime-image-deps
        name: Forbid CI-only image libraries in runtime requirements
        entry: bash -c '
          set -euo pipefail
          FORBIDDEN_DEPS="Pillow reportlab"
          for dep in $FORBIDDEN_DEPS; do
            if grep -iE "^${dep}\b" requirements.txt; then
              echo ""
              echo "ERROR: Forbidden runtime dependency detected: $dep"
              echo ""
              echo "Pillow and reportlab are CI-only dependencies."
              echo "Move them to requirements-dev.txt."
              echo ""
              exit 1
            fi
          done
        '
        language: system
        files: ^requirements\.txt$
