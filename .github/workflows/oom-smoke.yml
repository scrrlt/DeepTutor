name: OOM Smoke Test

on:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/performance/oom_repro/**'
      - 'requirements.txt'
      - 'requirements-dev.txt'
      - '.github/workflows/oom-smoke.yml'

jobs:
  oom-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Enforce runtime dependency policy
      # ------------------------------------------------------------
      - name: Enforce runtime dependency policy
        run: |
          set -euo pipefail

          FORBIDDEN_DEPS="Pillow reportlab"

          for dep in $FORBIDDEN_DEPS; do
            if grep -iE "^${dep}\b" requirements.txt; then
              echo "ERROR: Forbidden runtime dependency detected: $dep"
              exit 1
            fi
          done

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build OOM repro image
        run: |
          docker build -f tests/performance/oom_repro/Dockerfile -t repro:ci .

      # NEW: install CI-only tooling on the runner
      - name: Install CI tools
        run: |
          pip install -r requirements-dev.txt

      - name: Prepare logs dir and synthetic PDF
        run: |
          mkdir -p tests/performance/oom_repro/logs
          chmod 777 tests/performance/oom_repro/logs
          python3 tests/performance/oom_repro/generate_synthetic_pdf.py \
            --out tests/performance/oom_repro/synthetic_small.pdf

      - name: Run ingestion in memory-capped container (mock flush)
        env:
          MEMORY_CAP: 2g
        run: |
          docker run --rm \
            --memory=${MEMORY_CAP} \
            --memory-swap=${MEMORY_CAP} \
            -v "${{ github.workspace }}/tests/performance/oom_repro/logs:/app/tests/performance/oom_repro/logs" \
            -v "${{ github.workspace }}/tests/performance/oom_repro/synthetic_small.pdf:/data/synthetic_small.pdf:ro" \
            repro:ci \
            bash -c "python3 tests/performance/oom_repro/ingest_isolated.py \
              --file /data/synthetic_small.pdf \
              --kb_name ci_test \
              --batch-size 5 \
              --max-bytes 2000000 \
              --output-dir /app/tests/performance/oom_repro/logs \
              --use-mock-flush"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: oom-repro-logs
          path: tests/performance/oom_repro/logs
