name: OOM Smoke Test

on:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/performance/oom_repro/**'
      - '.github/workflows/oom-smoke.yml'

jobs:
  oom-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build OOM repro image
        run: |
          docker build -f tests/performance/oom_repro/Dockerfile -t repro:ci .

      - name: Prepare logs dir and synthetic PDF
        run: |
          mkdir -p tests/performance/oom_repro/logs
          chmod 777 tests/performance/oom_repro/logs
          python3 tests/performance/oom_repro/generate_synthetic_pdf.py --out tests/performance/oom_repro/synthetic_small.pdf

      - name: Run ingestion in memory-capped container (mock flush)
        env:
          MEMORY_CAP: 2g
        run: |
          docker run --rm \
            --memory=${MEMORY_CAP} --memory-swap=${MEMORY_CAP} \
            -v "${{ github.workspace }}/tests/performance/oom_repro/logs:/app/tests/performance/oom_repro/logs" \
            -v "${{ github.workspace }}/tests/performance/oom_repro/synthetic_small.pdf:/data/synthetic_small.pdf:ro" \
            repro:ci \
            bash -c "python3 tests/performance/oom_repro/ingest_isolated.py \
              --file /data/synthetic_small.pdf \
              --kb_name ci_test \
              --batch-size 5 \
              --max-bytes 2000000 \
              --output-dir /app/tests/performance/oom_repro/logs \
              --use-mock-flush true"

      - name: Wait for monitor summary
        run: |
          sleep 2
          ls -la tests/performance/oom_repro/logs || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: oom-repro-logs
          path: tests/performance/oom_repro/logs

      - name: Assert peak RSS under cap
        run: |
          SUMMARY="tests/performance/oom_repro/logs/summary.json"
          if [ ! -f "$SUMMARY" ]; then
            echo "Missing summary.json â€” failing CI"
            exit 1
          fi
          PEAK=$(jq -r '.peak_rss_mb' "$SUMMARY")
          if [ "$PEAK" = "null" ] || [ -z "$PEAK" ]; then
            echo "Invalid peak value: $PEAK"
            exit 1
          fi
          MEM_MB=$(echo "${MEMORY_CAP}" | awk '/[0-9]+g/ {print int($0) * 1024} /[0-9]+m/ {print int($0)}')
          THRESHOLD=$(awk "BEGIN {printf \"%d\", $MEM_MB * 0.95}")
          echo "Peak RSS MB: $PEAK ; Threshold MB: $THRESHOLD"
          if (( $(echo "$PEAK > $THRESHOLD" | bc -l) )); then
            echo "FAIL: peak RSS exceeds threshold"
            exit 1
          fi
          echo "PASS: peak RSS within threshold"